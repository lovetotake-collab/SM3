<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM3 í€€íŠ¸ ì˜¤í† íŒŒì¼ëŸ¿ v38 (ê°€ë…ì„± íŒ¨ì¹˜)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Pretendard', system-ui, sans-serif;
            color: #cbd5e1;
        }
        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
        }
        input[type="text"], input[type="number"] {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.5);
            color: white;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            transition: all 0.2s;
            font-variant-numeric: tabular-nums;
            font-size: 0.9rem;
        }
        input:focus {
            outline: none;
            border-color: #818cf8;
            background: rgba(15, 23, 42, 0.9);
            box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.2);
        }
        input[readonly] {
            background: rgba(51, 65, 85, 0.3);
            border-color: rgba(71, 85, 105, 0.3);
            color: #94a3b8;
            cursor: not-allowed;
        }
        
        /* ìƒíƒœ ë°°ì§€ */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; display: inline-block; white-space: nowrap; }
        .badge-wait { background: #475569; color: #e2e8f0; border: 1px solid #64748b; }
        .badge-monitor { background: #1e40af; color: #bfdbfe; border: 1px solid #3b82f6; }
        .badge-buying { background: #991b1b; color: #fecaca; border: 1px solid #ef4444; animation: pulse 2s infinite; }
        .badge-profit { background: #065f46; color: #a7f3d0; border: 1px solid #10b981; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* í…Œì´ë¸” */
        table { width: 100%; border-collapse: separate; border-spacing: 0 4px; }
        th { color: #94a3b8; font-weight: 600; text-align: center; padding: 12px; font-size: 0.8rem; letter-spacing: 0.05em; background: rgba(30, 41, 59, 0.8); }
        td { background: rgba(51, 65, 85, 0.4); padding: 14px 8px; text-align: center; border-top: 1px solid transparent; border-bottom: 1px solid transparent; font-size: 0.9rem; transition: background 0.3s; }
        tr:hover td { background: rgba(51, 65, 85, 0.6); border-top-color: rgba(255,255,255,0.05); border-bottom-color: rgba(255,255,255,0.05); cursor: pointer; }
        
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
        tr.dragging { opacity: 0.5; }
        tr.drag-over td { border-bottom: 2px solid #818cf8; }

        /* ì €ì  í•˜íšŒ ê°•ì¡° ìŠ¤íƒ€ì¼ (ë¶‰ì€ ë°°ê²½) */
        tr.low-alert td { background: rgba(127, 29, 29, 0.3); border-color: rgba(248, 113, 113, 0.2); }
        tr.low-alert:hover td { background: rgba(127, 29, 29, 0.4); }

        td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; border-left: 1px solid transparent; }
        td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; border-right: 1px solid transparent; }

        /* ê°€ê²© ê°•ì¡° */
        .reached-buy { text-decoration: line-through; opacity: 0.4; color: #f87171; }
        .reached-sell { text-decoration: line-through; opacity: 0.4; color: #34d399; }
        
        .active-buy-box { border: 1px solid #f87171; background: rgba(248, 113, 113, 0.1); border-radius: 4px; padding: 2px 6px; color: #f87171; font-weight: bold; box-shadow: 0 0 10px rgba(248, 113, 113, 0.2); }
        .active-sell-box { border: 1px solid #34d399; background: rgba(52, 211, 153, 0.1); border-radius: 4px; padding: 2px 6px; color: #34d399; font-weight: bold; box-shadow: 0 0 10px rgba(52, 211, 153, 0.2); }

        .btn-action { padding: 12px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; font-size: 0.95rem; }
        .btn-start { background: linear-gradient(135deg, #6366f1 0%, #4338ca 100%); color: white; box-shadow: 0 4px 6px -1px rgba(67, 56, 202, 0.4); }
        .btn-start:hover { transform: translateY(-1px); box-shadow: 0 6px 10px -1px rgba(67, 56, 202, 0.5); }
        .btn-update { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.4); }
        .btn-update:hover { transform: translateY(-1px); box-shadow: 0 6px 10px -1px rgba(16, 185, 129, 0.5); }
        .btn-reset { background: #334155; color: #cbd5e1; border: 1px solid #475569; }
        .btn-reset:hover { background: #475569; }
        
        /* ë²„íŠ¼ ê³µí†µ */
        .btn-common { padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 6px; cursor: pointer; border: none; }
        
        /* êµ¬ê¸€ ë¡œê·¸ì¸ ë²„íŠ¼ */
        .btn-google { background: #4285f4; color: white; }
        .btn-google:hover { background: #3367d6; }
        
        /* ë™ê¸°í™” ë²„íŠ¼ */
        .btn-sync { background: #10b981; color: white; }
        .btn-sync:hover { background: #059669; }
        .btn-sync:disabled { background: #475569; color: #94a3b8; cursor: not-allowed; }
        
        /* ì•Œë¦¼ ë‚´ì—­ ë²„íŠ¼ */
        .btn-history { background: #6366f1; color: white; position: relative; }
        .btn-history:hover { background: #4f46e5; }
        .noti-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; border: 2px solid #1e293b; display: none; }
        
        /* ì‚­ì œ ë²„íŠ¼ (ìˆ˜ì •ë¨: ë¶‰ì€ìƒ‰, ê°€ë¡œë°°ì¹˜ ê³ ì •) */
        .btn-delete { 
            background: #ef4444; color: white; padding: 6px 12px; 
            border-radius: 6px; font-size: 0.8rem; font-weight: 700; 
            border: none; cursor: pointer; transition: background 0.2s; 
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
            min-width: 50px;
        }
        .btn-delete:hover { background: #dc2626; transform: translateY(-1px); }
        
        .sync-status { display: flex; align-items: center; gap: 6px; font-size: 0.8rem; color: #94a3b8; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; }
        .sync-dot.connected { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .sync-dot.syncing { background: #f59e0b; animation: pulse 1s infinite; }

        /* í† ìŠ¤íŠ¸ */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 16px; border-radius: 12px; backdrop-filter: blur(8px); animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); max-width: 380px; box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.6); border-left: 4px solid #6366f1; }
        .toast-title { font-weight: 700; margin-bottom: 4px; color: #a5b4fc; font-size: 0.95rem; }
        .toast-body { font-size: 0.85rem; color: #e2e8f0; line-height: 1.5; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* ì•Œë¦¼ ëª¨ë‹¬ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #1e293b; width: 600px; max-width: 95%; max-height: 80vh; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; background: rgba(15, 23, 42, 0.5); }
        .modal-title { font-size: 1.2rem; font-weight: 700; color: #e2e8f0; }
        .modal-body { flex: 1; overflow-y: auto; padding: 0; }
        .history-item { padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; gap: 15px; align-items: flex-start; }
        .history-item:hover { background: rgba(255,255,255,0.02); }
        .h-time { font-size: 0.75rem; color: #94a3b8; min-width: 60px; font-weight: 600; padding-top: 2px; }
        .h-content { flex: 1; }
        .h-title { color: #e2e8f0; font-weight: 700; margin-bottom: 4px; font-size: 0.95rem; }
        .h-msg { color: #cbd5e1; font-size: 0.9rem; line-height: 1.4; }
        
        .label-text { font-size: 0.75rem; color: #94a3b8; margin-bottom: 4px; display: block; font-weight: 500; }
        
        /* íˆ´íŒ */
        .tooltip-container { position: relative; display: inline-block; width: 100%; }
        .tooltip-text {
            visibility: hidden; width: 220px; background-color: rgba(15, 23, 42, 0.95);
            color: #e2e8f0; text-align: left; border-radius: 8px; padding: 10px;
            position: absolute; z-index: 10; bottom: 125%; left: 50%;
            margin-left: -110px; opacity: 0; transition: opacity 0.3s;
            border: 1px solid rgba(255,255,255,0.1); font-size: 0.75rem; font-weight: normal;
            line-height: 1.4; pointer-events: none;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        /* ë“œë˜ê·¸ í•¸ë“¤ */
        .drag-handle { cursor: grab; color: #64748b; }
        .drag-handle:hover { color: #cbd5e1; }
    </style>
</head>
<body>
    <div class="max-w-[1600px] mx-auto">
        <!-- í—¤ë” -->
        <div class="card flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent flex items-center gap-2">
                    <span>âš¡</span> SM3 ì˜¤í† íŒŒì¼ëŸ¿ v38 (ê°€ë…ì„± íŒ¨ì¹˜)
                </h1>
                <p class="text-slate-400 text-sm mt-1">ë“œë˜ê·¸ ì •ë ¬ â€¢ í´ë¦­ ë¡œë“œ â€¢ ì•Œë¦¼ë‚´ì—­ ë²„íŠ¼</p>
            </div>
            
            <!-- ìš°ì¸¡ ì»¨íŠ¸ë¡¤ -->
            <div class="flex flex-col items-end gap-3">
                <div class="flex flex-wrap items-center gap-2">
                    <!-- ì•Œë¦¼ë‚´ì—­ ë²„íŠ¼ (NEW) -->
                    <button onclick="openHistoryModal()" class="btn-common btn-history">
                        ğŸ“œ ì•Œë¦¼ë‚´ì—­ <span id="notiBadge" class="noti-badge">0</span>
                    </button>
                    
                    <button onclick="manualBackup()" id="backupBtn" disabled class="btn-common btn-sync">ğŸ’¾ ë°±ì—…</button>
                    <button onclick="manualLoad()" id="loadBtn" disabled class="btn-common btn-sync">ğŸ“¥ ë¡œë“œ</button>
                    <button onclick="handleGoogleAuth()" class="btn-common btn-google">
                        <span id="googleBtnText">ğŸ” êµ¬ê¸€ ë¡œê·¸ì¸</span>
                    </button>
                </div>
                <div class="flex items-center gap-4 text-xs">
                    <div id="syncStatusWrapper" class="sync-status">
                        <div id="syncStatus" class="sync-dot"></div>
                        <span id="statusText">ë“œë¼ì´ë¸Œ ë¯¸ì—°ê²°</span>
                    </div>
                    <div id="apiStatus" class="flex items-center gap-2 text-slate-400 font-bold">
                        <div class="w-2 h-2 rounded-full bg-slate-500"></div> ì„œë²„ ì—°ê²° ëŒ€ê¸°ì¤‘
                    </div>
                </div>
                <div id="lastSyncTime" class="text-[10px] text-slate-500"></div>
            </div>
        </div>

        <!-- ì…ë ¥ í¼ -->
        <div class="card mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-indigo-300 flex items-center gap-2">
                    ğŸ“¡ ì¢…ëª© ë“±ë¡ ë° ì„¤ì •
                </h2>
                <span id="editModeIndicator" class="text-xs font-bold text-emerald-400 hidden">âœï¸ ìˆ˜ì • ëª¨ë“œ (ì¢…ëª©ëª… ì¼ì¹˜ì‹œ ë®ì–´ì“°ê¸°)</span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-3">
                <div class="md:col-span-1">
                    <span class="label-text">ì¢…ëª©ëª…</span>
                    <input type="text" id="stockName" placeholder="ì‚¼ì„±ì „ì">
                </div>
                <div class="md:col-span-1">
                    <span class="label-text">ì¢…ëª©ì½”ë“œ (í•„ìˆ˜)</span>
                    <input type="text" id="stockCode" placeholder="005930">
                </div>
                <div class="md:col-span-1">
                    <span class="label-text text-yellow-400">ğŸ”¥ ì‹ ê³ ê°€ (Reset ê¸°ì¤€)</span>
                    <input type="text" id="newHighPrice" class="text-right font-bold text-yellow-300" onkeyup="formatInput(this)" placeholder="ëŒíŒŒì‹œ ë¦¬ì…‹">
                </div>
                <div class="md:col-span-1">
                    <span class="label-text text-red-400">ê¸°ì¤€ ê³ ê°€ (SMí­ ê¸°ì¤€)</span>
                    <input type="text" id="highPrice" class="text-right font-bold" onkeyup="formatInput(this)">
                </div>
                <div class="md:col-span-1">
                    <span class="label-text text-blue-400">ê¸°ì¤€ ì €ê°€ (SMí­ ê¸°ì¤€)</span>
                    <input type="text" id="lowPrice" class="text-right font-bold" onkeyup="formatInput(this)">
                </div>
                <div class="md:col-span-1 flex items-end">
                    <div class="tooltip-container">
                        <label class="flex items-center gap-3 cursor-pointer p-2.5 rounded-lg bg-indigo-500/10 border border-indigo-500/30 w-full hover:bg-indigo-500/20 transition h-[42px]">
                            <input type="checkbox" id="autoMode" class="w-4 h-4 accent-indigo-500" checked>
                            <div class="font-bold text-sm text-indigo-300">ğŸ¤– ìë™ëŒ€ì‘ On</div>
                        </label>
                        <div class="tooltip-text">
                            <strong>ìë™ëŒ€ì‘ ëª¨ë“œ:</strong><br>
                            â€¢ On: ì €ì /ë°˜ë“± ì‹¤ì‹œê°„ ì¶”ì  & ìë™ ì…ë ¥<br>
                            â€¢ Off: ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ ê°’ìœ¼ë¡œ ê³ ì •
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-6 p-4 bg-slate-800/50 rounded-xl border border-slate-700/50">
                <div class="md:col-span-2">
                    <span class="label-text text-green-400">ğŸ“‰ ìˆ˜ì •ì €ê°€ (ì¸ì •ë°˜ë“±ì‹œ ê°±ì‹ )</span>
                    <input type="text" id="adjustedPrice" class="text-right bg-slate-900/80 border-slate-700 text-green-300 font-bold" readonly placeholder="ìë™ ì…ë ¥ë¨">
                    <p class="text-[10px] text-slate-500 mt-1">* íƒ€ì  ê³„ì‚°ì˜ ê¸°ì¤€ ìœ„ì¹˜ê°€ ë©ë‹ˆë‹¤.</p>
                </div>
                <div class="md:col-span-2">
                    <span class="label-text text-purple-400">ğŸ“ˆ ë°˜ë“±ì €ê°€ (ë§¤ë„ ê¸°ì¤€)</span>
                    <input type="text" id="bouncePrice" class="text-right bg-slate-900/80 border-slate-700 text-purple-300 font-bold" readonly placeholder="1ì°¨ ë§¤ìˆ˜ í›„ í™œì„±í™”">
                    <p class="text-[10px] text-slate-500 mt-1">* ì´ ê°€ê²© ê¸°ì¤€ìœ¼ë¡œ ë§¤ë„íƒ€ì ì´ ì„¤ì •ë©ë‹ˆë‹¤.</p>
                </div>
                <div class="md:col-span-2 flex gap-2 items-end">
                    <button onclick="addStock()" id="addBtn" class="btn-action btn-start flex-1 h-[42px]">ğŸš€ ê°ì‹œ ì‹œì‘</button>
                    <button onclick="resetInputs()" class="btn-action btn-reset h-[42px]">ì´ˆê¸°í™”</button>
                </div>
            </div>
        </div>

        <!-- ë¦¬ìŠ¤íŠ¸ -->
        <div class="card">
            <h2 class="text-lg font-bold mb-4 text-slate-300 flex items-center justify-between">
                <span>ğŸ“‹ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ í˜„í™©</span>
                <span class="text-xs text-slate-500 font-normal">ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½ ê°€ëŠ¥</span>
            </h2>
            <div class="overflow-x-auto">
                <table id="stockTable">
                    <thead>
                        <tr>
                            <th width="40">â‰¡</th>
                            <th width="80">ìƒíƒœ</th>
                            <th width="120">ì¢…ëª©ì •ë³´</th>
                            <th width="100">í˜„ì¬ê°€</th>
                            <th class="text-red-400">1ì°¨ ë§¤ìˆ˜</th>
                            <th class="text-red-400">2ì°¨ ë§¤ìˆ˜</th>
                            <th class="text-red-400">3ì°¨ ë§¤ìˆ˜</th>
                            <th class="text-red-400">4ì°¨ ë§¤ìˆ˜</th>
                            <th class="text-emerald-400">1ì°¨ ë§¤ë„</th>
                            <th class="text-emerald-400">2ì°¨ ë§¤ë„</th>
                            <th width="100">í‰ë‹¨/ë³¸ì „</th>
                            <th width="100">ê´€ë¦¬</th>
                        </tr>
                    </thead>
                    <tbody id="stockListBody"></tbody>
                </table>
                <div id="emptyMessage" class="text-center py-16 text-slate-600 text-sm bg-slate-800/20 rounded-lg border border-dashed border-slate-700 mt-2">
                    í˜„ì¬ ê°ì‹œ ì¤‘ì¸ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìœ„ ì„¤ì •ì°½ì—ì„œ ì¢…ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.
                </div>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ ë‚´ì—­ ëª¨ë‹¬ -->
    <div id="historyModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“œ ì•Œë¦¼ ë‚´ì—­</h3>
                <div class="flex gap-2">
                    <button onclick="clearHistory()" class="px-3 py-1.5 bg-slate-700 text-slate-300 rounded text-sm hover:bg-slate-600">ğŸ—‘ ê¸°ë¡ ì‚­ì œ</button>
                    <button onclick="closeHistoryModal()" class="px-3 py-1.5 bg-slate-700 text-white rounded text-sm hover:bg-slate-600">ë‹«ê¸°</button>
                </div>
            </div>
            <div id="historyList" class="modal-body">
                <div class="text-center py-12 text-slate-500 text-sm">ê¸°ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ==========================================
        //  SM3 QUANT ALGORITHM V38
        // ==========================================
        
        const socket = io('http://localhost:5000', { transports: ['websocket', 'polling'] });
        let stocks = JSON.parse(localStorage.getItem('smStocks_v21')) || [];
        stocks.forEach(s => {
            if (s.lowestAfterBuy === null) s.lowestAfterBuy = Infinity;
        });
        
        let history = JSON.parse(localStorage.getItem('smHistory_v30')) || [];
        let unreadCount = 0;
        let draggedIndex = null; 

        // ------------------------------------------
        //  0. êµ¬ê¸€ ë“œë¼ì´ë¸Œ (ìˆ˜ë™ ëª¨ë“œ)
        // ------------------------------------------
        const CLIENT_ID = '574140412573-n0jau2i3uph1v5p3hi9v004m44bnopq8.apps.googleusercontent.com';
        const API_KEY = '';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let accessToken = null;
        let driveFileId = null; 
        
        const DRIVE_FILENAME = 'SM3_data.json';
        
        let tokenRefreshTimer = null;
        let isSignedIn = false;

        function gapiLoaded() { gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] });
            gapiInited = true;
        }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES, callback: '',
            });
            gisInited = true;
        }
        
        const TOKEN_KEY = 'google_access_token_v4';
        const EXPIRY_KEY = 'google_token_expiry_v4';

        function handleGoogleAuth() {
            if (accessToken) {
                signOut();
            } else {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) throw (resp);
                    accessToken = gapi.client.getToken().access_token;
                    localStorage.setItem(TOKEN_KEY, accessToken);
                    
                    if (resp.expires_in) {
                        const expiryTime = Date.now() + (resp.expires_in * 1000);
                        localStorage.setItem(EXPIRY_KEY, expiryTime.toString());
                        setupTokenRefresh(resp.expires_in);
                    } else {
                        localStorage.setItem(EXPIRY_KEY, (Date.now() + 3600000).toString());
                        setupTokenRefresh(3600);
                    }
                    
                    isSignedIn = true;
                    updateSyncStatusUI('connected', 'ë™ê¸°í™” ì¤€ë¹„ë¨');
                    document.getElementById('googleBtnText').textContent = 'ğŸ”“ ë¡œê·¸ì•„ì›ƒ';
                    enableDriveButtons(true);
                    
                    alert('êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì•ˆì „í•˜ê²Œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.\n[ğŸ“¥ ë¡œë“œ] ë²„íŠ¼ì„ ëˆŒëŸ¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.');
                };
                tokenClient.requestAccessToken({prompt: 'consent'});
            }
        }
        
        function signOut() {
            if (accessToken) {
                google.accounts.oauth2.revoke(accessToken);
                accessToken = null;
                localStorage.removeItem(TOKEN_KEY);
                localStorage.removeItem(EXPIRY_KEY);
                if (tokenRefreshTimer) clearTimeout(tokenRefreshTimer);
                isSignedIn = false;
                
                updateSyncStatusUI('disconnected', 'ë“œë¼ì´ë¸Œ ë¯¸ì—°ê²°');
                document.getElementById('googleBtnText').textContent = 'ğŸ” êµ¬ê¸€ ë¡œê·¸ì¸';
                enableDriveButtons(false);
            }
        }
        
        function setupTokenRefresh(expiresInSeconds) {
            if (tokenRefreshTimer) clearTimeout(tokenRefreshTimer);
            const refreshTime = Math.max((expiresInSeconds - 300) * 1000, 60 * 1000);
            tokenRefreshTimer = setTimeout(async () => {
                if (isSignedIn && tokenClient) {
                    try {
                        tokenClient.callback = async (resp) => {
                            if (resp.error === undefined) {
                                accessToken = resp.access_token;
                                localStorage.setItem(TOKEN_KEY, accessToken);
                                if (resp.expires_in) {
                                    localStorage.setItem(EXPIRY_KEY, (Date.now() + (resp.expires_in * 1000)).toString());
                                    setupTokenRefresh(resp.expires_in);
                                }
                                gapi.client.setToken({ access_token: accessToken });
                            } else throw new Error(resp.error);
                        };
                        tokenClient.requestAccessToken({prompt: ''});
                    } catch (err) { signOut(); }
                }
            }, refreshTime);
        }

        async function restoreLoginState() {
            const savedToken = localStorage.getItem(TOKEN_KEY);
            const expiry = localStorage.getItem(EXPIRY_KEY);
            
            if (savedToken && expiry && Date.now() < parseInt(expiry)) {
                gapi.client.setToken({access_token: savedToken});
                accessToken = savedToken;
                isSignedIn = true;
                
                const remainingSeconds = Math.floor((parseInt(expiry) - Date.now()) / 1000);
                setupTokenRefresh(remainingSeconds);
                
                driveFileId = await findDriveFile(DRIVE_FILENAME);
                
                updateSyncStatusUI('connected', 'ë™ê¸°í™” ì¤€ë¹„ë¨');
                document.getElementById('googleBtnText').textContent = 'ğŸ”“ ë¡œê·¸ì•„ì›ƒ';
                enableDriveButtons(true);
            } else if (savedToken) {
                tryAutoRelogin();
            }
        }
        
        function tryAutoRelogin() {
            if (tokenClient) {
                tokenClient.callback = async (resp) => {
                    if (resp.error === undefined) {
                        accessToken = gapi.client.getToken().access_token;
                        localStorage.setItem(TOKEN_KEY, accessToken);
                        if (resp.expires_in) {
                            localStorage.setItem(EXPIRY_KEY, (Date.now() + (resp.expires_in * 1000)).toString());
                            setupTokenRefresh(resp.expires_in);
                        }
                        isSignedIn = true;
                        driveFileId = await findDriveFile(DRIVE_FILENAME);
                        updateSyncStatusUI('connected', 'ë™ê¸°í™” ì¤€ë¹„ë¨');
                        document.getElementById('googleBtnText').textContent = 'ğŸ”“ ë¡œê·¸ì•„ì›ƒ';
                        enableDriveButtons(true);
                    }
                };
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        async function saveToGoogleDrive() {
            if (!accessToken) return;
            updateSyncStatusUI('syncing', 'ì €ì¥ ì¤‘...');
            
            try {
                if (!driveFileId) driveFileId = await findDriveFile(DRIVE_FILENAME);
                
                const content = JSON.stringify(stocks, null, 2);
                const blob = new Blob([content], { type: 'application/json' });
                const metadata = { name: DRIVE_FILENAME, mimeType: 'application/json' };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);
                
                if (driveFileId) {
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`, {
                        method: 'PATCH', headers: { 'Authorization': `Bearer ${accessToken}` }, body: form
                    });
                } else {
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST', headers: { 'Authorization': `Bearer ${accessToken}` }, body: form
                    });
                    const result = await response.json();
                    driveFileId = result.id;
                }
                
                updateSyncStatusUI('connected', 'ì €ì¥ ì™„ë£Œ');
                updateLastSyncTime();
                setTimeout(() => updateSyncStatusUI('connected', 'ë™ê¸°í™” ì¤€ë¹„ë¨'), 2000);
            } catch (error) {
                console.error('Drive Save Error:', error);
                updateSyncStatusUI('disconnected', 'ì €ì¥ ì‹¤íŒ¨');
                alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
            }
        }
        
        async function loadFromGoogleDrive() {
            if (!accessToken) return;
            updateSyncStatusUI('syncing', 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            
            try {
                if (!driveFileId) driveFileId = await findDriveFile(DRIVE_FILENAME);
                if (!driveFileId) {
                    updateSyncStatusUI('connected', 'íŒŒì¼ ì—†ìŒ');
                    alert(`êµ¬ê¸€ ë“œë¼ì´ë¸Œì— '${DRIVE_FILENAME}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nêµ¬ë²„ì „ì—ì„œ [ë°±ì—…]ì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš”.`);
                    return;
                }
                
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${driveFileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (!Array.isArray(data)) {
                        alert("ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë°°ì—´ ì•„ë‹˜)");
                        return;
                    }

                    stocks = data;
                    
                    stocks.forEach((s, index) => {
                        if (!s.id) s.id = Date.now() + index;
                        if (s.lowestAfterBuy === null || s.lowestAfterBuy === "null") s.lowestAfterBuy = Infinity;
                        
                        if (!s.buyPoints || !Array.isArray(s.buyPoints) || s.buyPoints.length === 0) {
                            if (s.high && s.low) calculateBuyPoints(s); 
                        }
                        
                        if (!s.sellPoints || !Array.isArray(s.sellPoints)) {
                            s.sellPoints = [];
                            if (s.lowestAfterBuy !== Infinity) calculateSellPoints(s);
                        }

                        if (!s.status) s.status = 'MONITORING';
                        if (!s.buyExecuted) s.buyExecuted = [false, false, false, false];
                        if (!s.sellExecuted) s.sellExecuted = [false, false];
                        if (typeof s.avgPrice === 'undefined') s.avgPrice = 0;
                        if (!s.reachedFlags) s.reachedFlags = [false, false, false, false];
                    });

                    localStorage.setItem('smStocks_v21', JSON.stringify(stocks));
                    renderList();
                    refreshRealtime(); 
                    updateSyncStatusUI('connected', 'ë¡œë“œ ì™„ë£Œ');
                    updateLastSyncTime();
                    setTimeout(() => updateSyncStatusUI('connected', 'ë™ê¸°í™” ì¤€ë¹„ë¨'), 2000);
                } else {
                    const errText = await response.text();
                    throw new Error(`HTTP Error ${response.status}: ${errText}`);
                }
            } catch (error) {
                console.error('Drive Load Error:', error);
                updateSyncStatusUI('disconnected', 'ë¡œë“œ ì‹¤íŒ¨');
                alert("ë¡œë“œ ì‹¤íŒ¨: " + error.message);
            }
        }
        
        async function findDriveFile(filename) {
            try {
                const query = `name = '${filename}' and trashed = false`;
                const response = await gapi.client.drive.files.list({
                    q: query,
                    fields: 'files(id, name)', spaces: 'drive'
                });
                const files = response.result.files;
                return files && files.length > 0 ? files[0].id : null;
            } catch (error) { 
                console.error('Find File Error:', error);
                return null; 
            }
        }
        
        function updateSyncStatusUI(status, text) {
            const dot = document.getElementById('syncStatus');
            const txt = document.getElementById('statusText');
            dot.className = `sync-dot ${status}`;
            txt.textContent = text;
        }
        
        function updateLastSyncTime() {
            document.getElementById('lastSyncTime').textContent = `ìµœê·¼ í™œë™: ${new Date().toLocaleTimeString()}`;
        }
        
        function enableDriveButtons(enable) {
            document.getElementById('backupBtn').disabled = !enable;
            document.getElementById('loadBtn').disabled = !enable;
        }
        
        async function manualBackup() {
            if (confirm('êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ë°ì´í„°ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) await saveToGoogleDrive();
        }
        
        async function manualLoad() {
            if (confirm('êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? (í˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)')) await loadFromGoogleDrive();
        }

        // ------------------------------------------
        //  1. í†µì‹  ë° ë°ì´í„° ìˆ˜ì‹ 
        // ------------------------------------------
        socket.on('connect', () => {
            updateApiStatus(true);
            refreshRealtime();
        });
        socket.on('disconnect', () => updateApiStatus(false));

        socket.on('realtime_update', (data) => {
            const stock = stocks.find(s => s.code === data.code);
            if (!stock) return;

            stock.currentPrice = Math.abs(parseInt(data.data.current_price));
            stock.changeRate = parseFloat(data.data.change_rate);
            
            // [í•µì‹¬] ì•Œê³ ë¦¬ì¦˜ ì—”ì§„ êµ¬ë™
            runTradingEngine(stock);
            
            // [í•µì‹¬ ìˆ˜ì •] ì „ì²´ ë¦¬ìŠ¤íŠ¸ ë¦¬ë Œë”ë§ ëŒ€ì‹  ë°ì´í„° ì €ì¥ ë° ë¶€ë¶„ ì—…ë°ì´íŠ¸ ìˆ˜í–‰
            localStorage.setItem('smStocks_v21', JSON.stringify(stocks));
            updateRow(stock); // í™”ë©´ ê¹œë¹¡ì„ ë°©ì§€ìš© ë¶€ë¶„ ì—…ë°ì´íŠ¸
        });

        // ------------------------------------------
        //  2. íŠ¸ë ˆì´ë”© ì—”ì§„ (Trading Engine)
        // ------------------------------------------
        function runTradingEngine(stock) {
            if (!stock.autoMode) return;
            const current = stock.currentPrice;

            if (stock.status === 'WAITING') {
                if (current > stock.newHigh) {
                    stock.newHigh = current;
                    stock.sessionLow = current; 
                }
                if (current < stock.sessionLow) {
                    stock.sessionLow = current;
                }
                
                const bounceRate = calculateBounceRate(current, stock.sessionLow);
                if (bounceRate >= 6.0) {
                    stock.high = current;
                    stock.low = stock.sessionLow;
                    stock.status = 'MONITORING';
                    stock.adjusted = null;
                    
                    calculateBuyPoints(stock);
                    notify(stock.name, `ğŸš€ ê¸°ì¤€ë°˜ë“±(${bounceRate.toFixed(2)}%) ë°œìƒ! SMë¼ì¸ ì¬ì„¤ì •\n(ê³ :${formatPrice(stock.high)}, ì €:${formatPrice(stock.low)})`);
                }
            }
            else if (stock.status === 'MONITORING') {
                if (current > stock.newHigh) {
                    stock.status = 'WAITING';
                    stock.newHigh = current;
                    stock.sessionLow = current;
                    stock.buyPoints = []; 
                    notify(stock.name, `ğŸ’¥ ì‹ ê³ ê°€ ê°±ì‹ ! (${formatPrice(current)})\nê¸°ì¡´ ì„¸íŒ… íŒŒê´´ë¨. ê¸°ì¤€ë°˜ë“± ëŒ€ê¸° ëª¨ë“œ.`);
                    return;
                }

                if (current < stock.sessionLow) {
                    stock.sessionLow = current;
                }

                const bounceRate = calculateBounceRate(current, stock.sessionLow);

                if (bounceRate >= 4.0 && bounceRate < 6.0) {
                    if (stock.adjusted !== stock.sessionLow) {
                        stock.adjusted = stock.sessionLow;
                        calculateBuyPoints(stock); 
                        notify(stock.name, `âœ… ì¸ì •ë°˜ë“±(${bounceRate.toFixed(2)}%) ê°ì§€!\nìˆ˜ì •ì €ê°€ ê°±ì‹ : ${formatPrice(stock.adjusted)}`);
                    }
                }
                else if (bounceRate >= 6.0) {
                    if (stock.high !== current || stock.low !== stock.sessionLow) {
                        stock.high = current;
                        stock.low = stock.sessionLow;
                        stock.adjusted = null;
                        stock.sessionLow = current; 
                        calculateBuyPoints(stock);
                        notify(stock.name, `ğŸš€ ê¸°ì¤€ë°˜ë“±(${bounceRate.toFixed(2)}%) ë°œìƒ!\nSMë¼ì¸ ì „ì²´ ì¬ì„¤ì • ì™„ë£Œ`);
                    }
                }

                if (stock.buyPoints.length > 0 && current <= stock.buyPoints[0]) {
                    stock.status = 'BUYING';
                    stock.buyExecuted[0] = true;
                    stock.lowestAfterBuy = current; 
                    updateAvgPrice(stock);
                    notify(stock.name, `ğŸ”´ 1ì°¨ ë§¤ìˆ˜ ì²´ê²°! (${formatPrice(current)})\në°˜ë“±ì €ê°€(ë§¤ë„ê¸°ì¤€) ì¶”ì ì„ ì‹œì‘í•©ë‹ˆë‹¤.`);
                }
            }
            else if (stock.status === 'BUYING') {
                for (let i = 1; i < 4; i++) {
                    if (!stock.buyExecuted[i] && current <= stock.buyPoints[i]) {
                        stock.buyExecuted[i] = true;
                        updateAvgPrice(stock);
                        notify(stock.name, `ğŸ”´ ${i+1}ì°¨ ì¶”ê°€ ë§¤ìˆ˜ ì²´ê²°! í‰ë‹¨ê°€ ìˆ˜ì •ë¨`);
                    }
                }

                if (current < stock.lowestAfterBuy) {
                    stock.lowestAfterBuy = current;
                    calculateSellPoints(stock); 
                }

                checkSellLogic(stock, current);
            }
        }

        // ------------------------------------------
        //  3. ìˆ˜í•™ ë¡œì§ (Calculation Logic)
        // ------------------------------------------
        function calculateBounceRate(current, low) {
            if (low === 0) return 0;
            return ((current - low) / low) * 100;
        }

        function calculateBuyPoints(stock) {
            const range = stock.high - stock.low;
            const unit = range / 4;
            const baseLow = stock.adjusted || stock.low;

            stock.buyPoints = [
                adjustPrice(baseLow - (unit * 3)),
                adjustPrice(baseLow - (unit * 4)),
                adjustPrice((baseLow - (unit * 4)) - (unit * 3)),
                adjustPrice((baseLow - (unit * 4)) - (unit * 4))
            ];
            stock.unit = unit; 
        }

        function calculateSellPoints(stock) {
            if (stock.lowestAfterBuy === Infinity) return;
            const unit = stock.unit; 
            const bounceLow = stock.lowestAfterBuy;

            stock.sellPoints = [
                adjustPrice(bounceLow + (unit * 2)), 
                adjustPrice(bounceLow + (unit * 3))
            ];
        }

        function checkSellLogic(stock, current) {
            if (!stock.sellExecuted[0] && current >= stock.sellPoints[0]) {
                stock.sellExecuted[0] = true;
                notify(stock.name, `ğŸ”µ 1ì°¨ ë§¤ë„ ì„±ê³µ! (50% ì²­ì‚°)\nì”ëŸ‰ì€ 2ì°¨ ë˜ëŠ” ë³¸ì „ ë§¤ë„ ëŒ€ê¸°`);
            }

            if (!stock.sellExecuted[1] && current >= stock.sellPoints[1]) {
                stock.sellExecuted[1] = true;
                stock.status = 'DONE'; 
                notify(stock.name, `ğŸ’° 2ì°¨ ë§¤ë„ ì„±ê³µ! ëª¨ë“  ë¬¼ëŸ‰ ì²­ì‚° ì™„ë£Œ.`);
            }

            if (stock.sellExecuted[0] && !stock.sellExecuted[1]) {
                if (stock.sellPoints[0] > stock.avgPrice) {
                    if (current <= stock.avgPrice && !stock.breakEvenTriggered) {
                        stock.breakEvenTriggered = true;
                        notify(stock.name, `ğŸ›¡ï¸ ë³¸ì „ ìœ„í˜‘ ê°ì§€! (í‰ë‹¨ê°€: ${formatPrice(stock.avgPrice)})\në³¸ì „ ë§¤ë„(Break-even Stop) ì‹¤í–‰ ê¶Œì¥`);
                    }
                }
            }
        }

        // ------------------------------------------
        //  4. UI ë° ìœ í‹¸ë¦¬í‹° (ì›í´ë¦­ ëŒ€ì‘)
        // ------------------------------------------
        function addStock() {
            const name = document.getElementById('stockName').value;
            const code = document.getElementById('stockCode').value;
            const newHigh = parseInt(document.getElementById('newHighPrice').value.replace(/,/g, ''));
            const high = parseInt(document.getElementById('highPrice').value.replace(/,/g, ''));
            const low = parseInt(document.getElementById('lowPrice').value.replace(/,/g, ''));
            
            if (!name || !code || !high || !low || !newHigh) return alert('ëª¨ë“  í•„ìˆ˜ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.');

            const adjustedInput = document.getElementById('adjustedPrice').value;
            const bounceInput = document.getElementById('bouncePrice').value;
            const adjusted = adjustedInput ? parseInt(adjustedInput.replace(/,/g, '')) : null;
            const bounce = bounceInput ? parseInt(bounceInput.replace(/,/g, '')) : null;

            const stock = {
                id: Date.now(),
                name, code, 
                newHigh, 
                high, low,
                sessionLow: low, 
                adjusted: adjusted,
                status: 'MONITORING', 
                autoMode: document.getElementById('autoMode').checked,
                currentPrice: 0,
                unit: 0,
                buyPoints: [],
                buyExecuted: [false, false, false, false],
                avgPrice: 0,
                lowestAfterBuy: bounce || Infinity, 
                sellPoints: [],
                sellExecuted: [false, false],
                breakEvenTriggered: false,
                reachedFlags: [false, false, false, false]
            };

            calculateBuyPoints(stock); 
            calculateSellPoints(stock);
            
            const existingIndex = stocks.findIndex(s => s.name === name);
            if (existingIndex !== -1) {
                stocks[existingIndex] = stock;
                alert(`${name} ì„¤ì •ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                stocks.push(stock);
            }
            
            saveAndRender(); // ì¶”ê°€/ìˆ˜ì •ì€ êµ¬ì¡°ê°€ ë°”ë€Œë¯€ë¡œ ì „ì²´ ë¦¬ë Œë”ë§
            refreshRealtime();
            resetInputs();
        }

        function renderList() {
            const tbody = document.getElementById('stockListBody');
            tbody.innerHTML = '';
            
            if (stocks.length === 0) {
                document.getElementById('emptyMessage').style.display = 'block';
                return;
            }
            document.getElementById('emptyMessage').style.display = 'none';

            stocks.forEach((s, idx) => {
                let badge = '';
                let statusText = '';
                if (s.status === 'WAITING') { badge = 'badge-wait'; statusText = 'ì‹ ê³ ê°€ ê°±ì‹ '; }
                else if (s.status === 'MONITORING') { badge = 'badge-monitor'; statusText = 'ë§¤ìˆ˜ ê°ì‹œì¤‘'; }
                else if (s.status === 'BUYING') { badge = 'badge-buying'; statusText = 'ë§¤ìˆ˜ ë³´ìœ ì¤‘'; }
                else if (s.status === 'DONE') { badge = 'badge-profit'; statusText = 'ì²­ì‚° ì™„ë£Œ'; }

                const tr = document.createElement('tr');
                tr.dataset.index = idx;
                // [ì¤‘ìš”] í–‰ ì „ì²´ì— í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ê±¸ì§€ë§Œ, ë“œë˜ê·¸ í•¸ë“¤ê³¼ ì‚­ì œë²„íŠ¼ì€ ì œì™¸ë¨
                tr.addEventListener('click', () => fillInputs(s));
                
                // ë“œë˜ê·¸ ì´ë²¤íŠ¸ (í–‰ ì „ì²´ê°€ ì•„ë‹Œ í•¸ë“¤ì—ì„œë§Œ ì‹œì‘ë˜ë„ë¡ ì œì–´)
                tr.addEventListener('dragstart', handleDragStart);
                tr.addEventListener('dragover', handleDragOver);
                tr.addEventListener('drop', handleDrop);
                tr.addEventListener('dragend', handleDragEnd);
                
                if ((s.currentPrice > 0 && s.currentPrice < s.low) || (s.lowestAfterBuy !== Infinity && s.currentPrice > 0 && s.currentPrice < s.lowestAfterBuy)) {
                    tr.classList.add('low-alert');
                }
                
                // ID ë¶€ì—¬ (ë¶€ë¶„ ì—…ë°ì´íŠ¸ìš©)
                tr.id = `tr-${s.id}`;

                tr.innerHTML = `
                    <td class="text-center text-slate-500 cursor-grab drag-handle"
                        onmouseover="this.parentElement.setAttribute('draggable', 'true')" 
                        onmouseout="this.parentElement.setAttribute('draggable', 'false')"
                        onclick="event.stopPropagation()">â‰¡</td>
                    <td><span id="badge-${s.id}" class="badge ${badge}">${statusText}</span></td>
                    <td class="text-left pl-4">
                        <div class="font-bold text-slate-200">${s.name}</div>
                        <div class="text-xs text-slate-500">${s.code}</div>
                        ${s.adjusted ? `<div class="text-[10px] text-green-400 mt-1">Adj: ${formatPrice(s.adjusted)}</div>` : ''}
                    </td>
                    <td>
                        <div class="flex flex-col items-center justify-center">
                             <!-- Price -->
                            <div id="price-${s.id}" class="text-[15px] font-bold tracking-tight ${s.changeRate > 0 ? 'text-red-400' : s.changeRate < 0 ? 'text-blue-400' : 'text-slate-300'}">
                                ${formatPrice(s.currentPrice)}
                            </div>
                             <!-- Rate -->
                            <div id="rate-${s.id}" class="text-[11px] font-semibold mt-1 px-1.5 py-0.5 rounded ${s.changeRate > 0 ? 'bg-red-500/20 text-red-300' : s.changeRate < 0 ? 'bg-blue-500/20 text-blue-300' : 'bg-slate-700 text-slate-400'}">
                                ${s.changeRate > 0 ? 'â–²' : s.changeRate < 0 ? 'â–¼' : ''} ${Math.abs(s.changeRate).toFixed(2)}%
                            </div>
                        </div>
                    </td>
                    ${renderBuyCellsWithIds(s)}
                    ${renderSellCellsWithIds(s)}
                    <td>
                        <div id="avg-${s.id}" class="text-indigo-300 font-bold">${s.avgPrice ? formatPrice(s.avgPrice) : '-'}</div>
                        ${s.lowestAfterBuy !== Infinity ? `<div class="text-[10px] text-purple-400">ë°˜ë“±ì €: ${formatPrice(s.lowestAfterBuy)}</div>` : ''}
                    </td>
                    <td><button onclick="removeStock(${s.id}, event)" class="btn-delete">ì‚­ì œ</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // ë¶€ë¶„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (DOM ê¹œë¹¡ì„ ë°©ì§€)
        function updateRow(s) {
            const tr = document.getElementById(`tr-${s.id}`);
            if(!tr) return;
            
            // ë°°ì§€ ì—…ë°ì´íŠ¸
            const badge = document.getElementById(`badge-${s.id}`);
            if(badge) {
                let badgeClass = '', statusText = '';
                if (s.status === 'WAITING') { badgeClass = 'badge-wait'; statusText = 'ì‹ ê³ ê°€ ê°±ì‹ '; }
                else if (s.status === 'MONITORING') { badgeClass = 'badge-monitor'; statusText = 'ë§¤ìˆ˜ ê°ì‹œì¤‘'; }
                else if (s.status === 'BUYING') { badgeClass = 'badge-buying'; statusText = 'ë§¤ìˆ˜ ë³´ìœ ì¤‘'; }
                else if (s.status === 'DONE') { badgeClass = 'badge-profit'; statusText = 'ì²­ì‚° ì™„ë£Œ'; }
                badge.className = `badge ${badgeClass}`;
                badge.textContent = statusText;
            }
            
            // ê°€ê²© ì—…ë°ì´íŠ¸
            const priceEl = document.getElementById(`price-${s.id}`);
            const rateEl = document.getElementById(`rate-${s.id}`);
            
            const isUp = s.changeRate > 0;
            const isDown = s.changeRate < 0;
            
            if(priceEl) {
                priceEl.textContent = formatPrice(s.currentPrice);
                // Update color class
                priceEl.className = `text-[15px] font-bold tracking-tight ${isUp ? 'text-red-400' : isDown ? 'text-blue-400' : 'text-slate-300'}`;
            }
            if(rateEl) {
                const sign = isUp ? 'â–²' : isDown ? 'â–¼' : '';
                rateEl.textContent = `${sign} ${Math.abs(s.changeRate).toFixed(2)}%`;
                // Update badge style
                rateEl.className = `text-[11px] font-semibold mt-1 px-1.5 py-0.5 rounded ${isUp ? 'bg-red-500/20 text-red-300' : isDown ? 'bg-blue-500/20 text-blue-300' : 'bg-slate-700 text-slate-400'}`;
            }
            
            // ë§¤ìˆ˜/ë§¤ë„/í‰ë‹¨ê°€ ì…€ ì—…ë°ì´íŠ¸ (ë‚´ìš©ë§Œ êµì²´)
            // ë§¤ìˆ˜ì…€
            s.buyPoints.forEach((p, i) => {
                const cell = document.getElementById(`buy-${s.id}-${i}`);
                if(cell) {
                    const isActive = s.currentPrice > 0 && Math.abs(s.currentPrice - p)/p < 0.01; 
                    const isDone = s.buyExecuted[i];
                    const cls = isDone ? 'reached-buy' : (isActive ? 'active-buy-box' : '');
                    cell.innerHTML = `<span class="${cls}">${formatPrice(p)}</span>`;
                }
            });
            // ë§¤ë„ì…€
            if(s.sellPoints && s.sellPoints.length > 0) {
                s.sellPoints.forEach((p, i) => {
                    const cell = document.getElementById(`sell-${s.id}-${i}`);
                    if(cell) {
                        const isDone = s.sellExecuted[i];
                        const isActive = !isDone && s.currentPrice >= p;
                        const cls = isDone ? 'reached-sell' : (isActive ? 'active-sell-box' : '');
                        cell.innerHTML = `<span class="${cls}">${formatPrice(p)}</span>`;
                    }
                });
            }
            // í‰ë‹¨ê°€
            const avg = document.getElementById(`avg-${s.id}`);
            if(avg) avg.textContent = s.avgPrice ? formatPrice(s.avgPrice) : '-';
        }

        // --- Drag & Drop Handlers ---
        function handleDragStart(e) {
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        }
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        function handleDrop(e) {
            e.stopPropagation();
            this.classList.remove('drag-over');
            const targetIndex = parseInt(this.dataset.index);
            if (draggedIndex !== null && draggedIndex !== targetIndex) {
                const item = stocks.splice(draggedIndex, 1)[0];
                stocks.splice(targetIndex, 0, item);
                saveAndRender();
            }
            return false;
        }
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('tr').forEach(tr => tr.classList.remove('drag-over'));
        }

        // --- Fill Inputs ---
        function fillInputs(s) {
            document.getElementById('stockName').value = s.name;
            document.getElementById('stockCode').value = s.code;
            document.getElementById('newHighPrice').value = formatValue(s.newHigh);
            document.getElementById('highPrice').value = formatValue(s.high);
            document.getElementById('lowPrice').value = formatValue(s.low);
            document.getElementById('adjustedPrice').value = s.adjusted ? formatValue(s.adjusted) : '';
            document.getElementById('bouncePrice').value = (s.lowestAfterBuy !== Infinity) ? formatValue(s.lowestAfterBuy) : '';
            
            const autoCheck = document.getElementById('autoMode');
            if (autoCheck.checked !== s.autoMode) {
                autoCheck.click(); 
            }
            
            const btn = document.getElementById('addBtn');
            btn.textContent = "ì„¤ì • ì—…ë°ì´íŠ¸";
            btn.classList.add('btn-update');
            btn.classList.remove('btn-start');
            document.getElementById('editModeIndicator').classList.remove('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderBuyCellsWithIds(s) {
            if (s.status === 'WAITING') return `<td colspan="4" class="text-slate-500 text-xs py-4">ì‹ ê³ ê°€ ê°±ì‹ ë¨. ìƒˆë¡œìš´ ê¸°ì¤€ë°˜ë“± ëŒ€ê¸°ì¤‘...</td>`;
            
            return s.buyPoints.map((p, i) => {
                const isActive = s.currentPrice > 0 && Math.abs(s.currentPrice - p)/p < 0.01; 
                const isDone = s.buyExecuted[i];
                const cls = isDone ? 'reached-buy' : (isActive ? 'active-buy-box' : '');
                return `<td id="buy-${s.id}-${i}"><span class="${cls}">${formatPrice(p)}</span></td>`;
            }).join('');
        }

        function renderSellCellsWithIds(s) {
            if (!s.sellPoints || s.sellPoints.length === 0) {
                return `<td class="text-slate-600 text-xs">-</td><td class="text-slate-600 text-xs">-</td>`;
            }
            if (s.status !== 'BUYING' && s.status !== 'DONE' && s.lowestAfterBuy === Infinity) {
                return `<td class="text-slate-600 text-xs">-</td><td class="text-slate-600 text-xs">-</td>`;
            }
            return s.sellPoints.map((p, i) => {
                const isDone = s.sellExecuted[i];
                const isActive = !isDone && s.currentPrice >= p;
                const cls = isDone ? 'reached-sell' : (isActive ? 'active-sell-box' : '');
                return `<td id="sell-${s.id}-${i}"><span class="${cls}">${formatPrice(p)}</span></td>`;
            }).join('');
        }

        function updateAvgPrice(s) {
            const executed = s.buyPoints.filter((_, i) => s.buyExecuted[i]);
            if (executed.length === 0) return;
            const sum = executed.reduce((a, b) => a + b, 0);
            s.avgPrice = Math.floor(sum / executed.length);
        }

        function saveAndRender() {
            localStorage.setItem('smStocks_v21', JSON.stringify(stocks));
            renderList();
        }

        function refreshRealtime() {
            if (socket.connected && stocks.length > 0) {
                const list = stocks.map(s => ({ code: s.code, name: s.name, buy_point: null }));
                socket.emit('register_stocks', { source: 'SM3_v21', stocks: list });
            }
        }

        // --- Log Functions ---
        function addLog(title, msg) {
            const time = new Date().toLocaleTimeString();
            history.unshift({ time, title, msg });
            if (history.length > 100) history.pop(); 
            localStorage.setItem('smHistory_v30', JSON.stringify(history));
            if(document.getElementById('historyModal').classList.contains('active')) {
                renderHistoryModal();
            } else {
                unreadCount++;
                updateBadge();
            }
        }

        function renderHistoryModal() {
            const container = document.getElementById('historyList');
            if (history.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-slate-500 text-sm">ê¸°ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            container.innerHTML = history.map(item => `
                <div class="history-item">
                    <div class="h-time">${item.time}</div>
                    <div class="h-content">
                        <div class="h-title">${item.title}</div>
                        <div class="h-msg">${item.msg}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function openHistoryModal() {
            document.getElementById('historyModal').classList.add('active');
            renderHistoryModal();
            unreadCount = 0;
            updateBadge();
        }
        
        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        function clearHistory() {
            if(confirm('ëª¨ë“  ì•Œë¦¼ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                history = [];
                localStorage.removeItem('smHistory_v30');
                renderHistoryModal();
            }
        }
        
        function updateBadge() {
            const badge = document.getElementById('notiBadge');
            if(unreadCount > 0) {
                badge.style.display = 'inline-block';
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
            } else {
                badge.style.display = 'none';
            }
        }

        // --- Helpers ---
        function adjustPrice(p) {
            p = Math.floor(p);
            if (p < 1000) return p;
            if (p < 5000) return Math.floor(p/5)*5;
            if (p < 10000) return Math.floor(p/10)*10;
            if (p < 50000) return Math.floor(p/50)*50;
            if (p < 100000) return Math.floor(p/100)*100;
            return Math.floor(p/1000)*1000;
        }
        function formatPrice(p) { return p ? p.toLocaleString() : '-'; }
        function formatValue(p) { return p ? p.toLocaleString() : ''; }
        function formatInput(el) { el.value = el.value.replace(/\D/g,'').replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
        
        function removeStock(id, e) {
            e.stopPropagation(); 
            if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { 
                stocks = stocks.filter(s=>s.id!==id); 
                saveAndRender(); 
                refreshRealtime(); 
            }
        }
        
        function resetInputs() {
            document.getElementById('stockName').value = '';
            document.getElementById('stockCode').value = '';
            document.getElementById('newHighPrice').value = '';
            document.getElementById('highPrice').value = '';
            document.getElementById('lowPrice').value = '';
            document.getElementById('adjustedPrice').value = '';
            document.getElementById('bouncePrice').value = '';
            
            const btn = document.getElementById('addBtn');
            btn.textContent = "ğŸš€ ê°ì‹œ ì‹œì‘";
            btn.classList.remove('btn-update');
            btn.classList.add('btn-start');
            document.getElementById('editModeIndicator').classList.add('hidden');
        }
        function updateApiStatus(con) {
            const el = document.getElementById('apiStatus');
            el.innerHTML = con ? '<div class="w-2 h-2 rounded-full bg-emerald-500"></div> ì„œë²„ ì—°ê²°ë¨' : '<div class="w-2 h-2 rounded-full bg-red-500"></div> ì—°ê²° ëŠê¹€';
            el.className = con ? 'px-4 py-2 rounded-full bg-emerald-500/10 text-emerald-400 text-xs font-bold flex items-center gap-2 border border-emerald-500/20' : 'px-4 py-2 rounded-full bg-red-500/10 text-red-400 text-xs font-bold flex items-center gap-2 border border-red-500/20';
        }
        function notify(title, body) {
            const box = document.getElementById('toastContainer');
            const el = document.createElement('div');
            el.className = 'toast';
            el.innerHTML = `<div class="toast-title">${title}</div><div class="toast-body">${body.replace(/\n/g, '<br>')}</div>`;
            box.appendChild(el);
            setTimeout(()=>el.remove(), 5000);
            addLog(title, body);
        }

        document.getElementById('autoMode').addEventListener('change', function() {
            const isAuto = this.checked;
            const adjInput = document.getElementById('adjustedPrice');
            const bounceInput = document.getElementById('bouncePrice');
            
            if (isAuto) {
                adjInput.readOnly = true;
                adjInput.placeholder = "ìë™ ì…ë ¥ë¨";
                bounceInput.readOnly = true;
                bounceInput.placeholder = "1ì°¨ ë§¤ìˆ˜ í›„ í™œì„±í™”";
                adjInput.classList.add('bg-slate-900/80');
                bounceInput.classList.add('bg-slate-900/80');
            } else {
                adjInput.readOnly = false;
                adjInput.placeholder = "ìˆ˜ë™ ì…ë ¥";
                bounceInput.readOnly = false;
                bounceInput.placeholder = "ìˆ˜ë™ ì…ë ¥";
                adjInput.classList.remove('bg-slate-900/80');
                bounceInput.classList.remove('bg-slate-900/80');
            }
        });

        let gapiLoading = false;
        const initCheckInterval = setInterval(() => {
            if (typeof gapi !== 'undefined' && !gapiInited && !gapiLoading) {
                gapiLoading = true;
                gapiLoaded();
            }
            if (typeof google !== 'undefined' && !gisInited) {
                gisLoaded();
            }
            if (gapiInited && gisInited) {
                clearInterval(initCheckInterval);
                restoreLoginState();
            }
        }, 100);
        
        renderList();
    </script>
</body>
</html>